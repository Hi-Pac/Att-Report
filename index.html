<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة بيانات الحضور والانصراف</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.3/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.5/css/buttons.dataTables.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Custom Theme & Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4C51BF',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#181818'
                    },
                    fontFamily: {
                        tajawal: ['Tajawal', 'sans-serif']
                    }
                }
            }
        };
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .loading-spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-left-color: #5D5CDE;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* DataTables RTL & Dark Mode */
        table.dataTable { width:100%!important; border-collapse:collapse!important; }
        table.dataTable td, table.dataTable th { padding:0.75rem; text-align:right; }
        .dt-buttons .dt-button { padding:0.5rem 1rem; background:#5D5CDE; color:#fff; border:none; border-radius:0.25rem; margin-right:0.5rem; }
        .dt-buttons .dt-button:hover { background:#4C51BF; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary mb-2">إدارة بيانات الحضور والانصراف</h1>
            <p class="text-gray-600 dark:text-gray-300">تحليل وإدارة سجلات الحضور والانصراف والرواتب</p>
        </header>

        <!-- Authentication -->
        <section id="auth-section" class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">تسجيل الدخول</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block mb-1 text-gray-700 dark:text-gray-300">البريد الإلكتروني</label>
                    <input type="email" id="email" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                </div>
                <div>
                    <label for="password" class="block mb-1 text-gray-700 dark:text-gray-300">كلمة المرور</label>
                    <input type="password" id="password" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                </div>
                <button type="submit" class="w-full py-2 bg-primary hover:bg-primary/90 text-white rounded-md transition">تسجيل الدخول</button>
                <p id="login-error" class="text-danger hidden"></p>
            </form>
        </section>

        <!-- Main App -->
        <section id="app-section" class="hidden">
            <!-- Tabs -->
            <div class="flex flex-wrap mb-6 border-b dark:border-gray-700">
                <button class="tab-btn tab-active py-2 px-4 rounded-t-lg" data-tab="attendance"><i class="fas fa-clipboard-list ml-1"></i> سجلات الحضور</button>
                <button class="tab-btn py-2 px-4" data-tab="employees"><i class="fas fa-users ml-1"></i> الموظفين</button>
                <button class="tab-btn py-2 px-4" data-tab="reports"><i class="fas fa-chart-bar ml-1"></i> التقارير</button>
                <button class="tab-btn py-2 px-4" data-tab="payroll"><i class="fas fa-money-bill-wave ml-1"></i> المرتبات</button>
                <div class="mr-auto flex items-center">
                    <button id="logout-btn" class="text-gray-600 dark:text-gray-400 hover:text-danger flex items-center"><i class="fas fa-sign-out-alt ml-1"></i> تسجيل الخروج</button>
                    <button id="theme-toggle" class="ml-4 text-gray-600 dark:text-gray-300"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i></button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-section" class="flex flex-col items-center py-12">
                <div class="loading-spinner mb-4"></div>
                <p class="text-gray-600 dark:text-gray-400">جاري تحميل البيانات...</p>
            </div>

            <!-- Tab Contents Container -->
            <div id="tab-content-container">
                <!-- Attendance Tab -->
                <div id="attendance-tab" class="tab-content active">
                    <!-- Filters -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-wrap gap-4">
                            <!-- Date Filter -->
                            <div class="flex-1 min-w-[200px]">
                                <label class="block mb-1 text-gray-700 dark:text-gray-300">فلترة حسب التاريخ</label>
                                <div class="flex gap-2">
                                    <input type="date" id="date-from" class="flex-1 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                    <input type="date" id="date-to" class="flex-1 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                    <button id="filter-date" class="py-2 px-4 bg-primary text-white rounded-md"><i class="fas fa-filter"></i></button>
                                </div>
                            </div>
                            <!-- Employee Filter -->
                            <div class="flex-1 min-w-[200px]">
                                <label class="block mb-1 text-gray-700 dark:text-gray-300">فلترة حسب الموظف</label>
                                <div class="flex gap-2">
                                    <select id="employee-filter" class="flex-1 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">جميع الموظفين</option></select>
                                    <button id="filter-employee" class="py-2 px-4 bg-primary text-white rounded-md"><i class="fas fa-filter"></i></button>
                                </div>
                            </div>
                            <!-- Type Filter -->
                            <div class="flex-1 min-w-[200px]">
                                <label class="block mb-1 text-gray-700 dark:text-gray-300">فلترة حسب نوع التسجيل</label>
                                <div class="flex gap-2">
                                    <select id="type-filter" class="flex-1 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        <option value="">الكل</option>
                                        <option value="حضور">حضور</option>
                                        <option value="انصراف">انصراف</option>
                                    </select>
                                    <button id="filter-type" class="py-2 px-4 bg-primary text-white rounded-md"><i class="fas fa-filter"></i></button>
                                </div>
                            </div>
                        </div>
                        <!-- Attendance Table -->
                        <div class="overflow-x-auto mt-4">
                            <table id="attendance-table" class="display stripe hover" style="width:100%">
                                <thead>
                                    <tr><th>الموظف</th><th>التاريخ</th><th>الوقت</th><th>نوع التسجيل</th><th>الموقع</th><th>ساعات العمل</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Employees Tab -->
                <div id="employees-tab" class="tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">قائمة الموظفين</h3>
                            <button id="add-employee-btn" class="py-2 px-4 bg-success text-white rounded-md"><i class="fas fa-plus ml-1"></i> إضافة موظف</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="employees-table" class="display stripe hover" style="width:100%">
                                <thead>
                                    <tr><th>الاسم</th><th>بيانات الاتصال</th><th>تاريخ التعيين</th><th>الراتب الأساسي</th><th>إجراءات</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports-tab" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Monthly Attendance Chart -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">نسبة الحضور والغياب الشهرية</h3>
                            <div class="h-72 relative"><canvas id="attendance-chart"></canvas></div>
                        </div>
                        <!-- Work Hours Chart -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">ساعات العمل حسب الموظف</h3>
                            <div class="h-72 relative"><canvas id="hours-chart"></canvas></div>
                        </div>
                    </div>
                    <!-- Employee Report Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                        <div class="mb-4 flex items-center gap-2">
                            <label class="block text-gray-700 dark:text-gray-300">اختر الشهر</label>
                            <input type="month" id="report-month" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            <button id="generate-report" class="py-2 px-4 bg-primary text-white rounded-md">إنشاء التقرير</button>
                        </div>
                        <div id="report-container" class="hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-medium">تقرير الشهر: <span id="report-title"></span></h4>
                                <div class="flex gap-2">
                                    <button id="export-excel" class="py-1 px-3 bg-success text-white rounded-md text-sm"><i class="fas fa-file-excel ml-1"></i> Excel</button>
                                    <button id="export-pdf" class="py-1 px-3 bg-danger text-white rounded-md text-sm"><i class="fas fa-file-pdf ml-1"></i> PDF</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="report-table" class="display stripe hover" style="width:100%">
                                    <thead>
                                        <tr><th>الموظف</th><th>أيام الحضور</th><th>أيام الغياب</th><th>مجموع ساعات العمل</th><th>متوسط ساعات العمل اليومية</th><th>عدد مرات التأخير</th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payroll Tab -->
                <div id="payroll-tab" class="tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                        <div class="mb-4 flex items-center gap-2">
                            <label class="block text-gray-700 dark:text-gray-300">اختر الشهر</label>
                            <input type="month" id="payroll-month" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            <button id="calculate-payroll" class="py-2 px-4 bg-primary text-white rounded-md">حساب المرتبات</button>
                        </div>
                        <div id="payroll-container" class="hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-medium">مرتبات شهر: <span id="payroll-title"></span></h4>
                                <div class="flex gap-2">
                                    <button id="export-payroll-excel" class="py-1 px-3 bg-success text-white rounded-md text-sm"><i class="fas fa-file-excel ml-1"></i> Excel</button>
                                    <button id="export-payroll-pdf" class="py-1 px-3 bg-danger text-white rounded-md text-sm"><i class="fas fa-file-pdf ml-1"></i> PDF</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="payroll-table" class="display stripe hover" style="width:100%">
                                    <thead>
                                        <tr><th>الموظف</th><th>الراتب الأساسي</th><th>أيام العمل</th><th>ساعات العمل</th><th>البدلات</th><th>الخصومات</th><th>صافي الراتب</th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employee Modal -->
            <div id="employee-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 max-w-md w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modal-title" class="text-lg font-semibold">إضافة موظف جديد</h3>
                        <button class="close-modal text-gray-500"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="employee-form" class="space-y-4">
                        <input type="hidden" id="employee-id" />
                        <div>
                            <label class="block mb-1 text-gray-700 dark:text-gray-300">الاسم الكامل</label>
                            <input type="text" id="employee-name-input" name="name" required class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-700 dark:text-gray-300">رقم الهاتف</label>
                            <input type="tel" id="employee-phone-input" name="phone" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-700 dark:text-gray-300">تاريخ التعيين</label>
                            <input type="date" id="employee-hire-date-input" name="hireDate" required class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-700 dark:text-gray-300">الراتب الأساسي</label>
                            <input type="number" id="employee-salary-input" name="baseSalary" required class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" class="close-modal py-2 px-4 border rounded-md dark:border-gray-600 dark:text-gray-300">إلغاء</button>
                            <button type="submit" class="py-2 px-4 bg-success text-white rounded-md">حفظ</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>

    <!-- Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.5/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Main Script -->
    <script>
        // Firebase config
        const firebaseConfig = { /* ... */ };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global
        let attendanceTable, employeesTable, reportTable, payrollTable;
        let attendanceData = [], employeesData = [], attendanceChart, hoursChart;
        let isEditMode = false;

        // Utils
        const formatDate = d => {
            const date = d || new Date();
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        };
        const formatDateForDisplay = ds => {
            if (!ds) return '';
            const [y,m,d] = ds.split('-');
            return `${d}/${m}/${y}`;
        };

        // Auth
        $('#login-form').on('submit', async e => {
            e.preventDefault();
            $('#login-error').addClass('hidden');
            try {
                await auth.signInWithEmailAndPassword($('#email').val(), $('#password').val());
            } catch (err) {
                $('#login-error').text(err.message).removeClass('hidden');
            }
        });
        $('#logout-btn').on('click', () => auth.signOut());
        auth.onAuthStateChanged(user => {
            if (user) {
                $('#auth-section').hide(); $('#app-section').show(); initApp();
            } else {
                $('#app-section').hide(); $('#auth-section').show(); $('#login-form')[0].reset();
            }
        });

        // Theme toggle
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        $('#theme-toggle').on('click', () => document.documentElement.classList.toggle('dark'));

        // Tabs
        $('.tab-btn').on('click', function() {
            $('.tab-btn').removeClass('tab-active'); $(this).addClass('tab-active');
            $('.tab-content').removeClass('active'); $(`#${$(this).data('tab')}-tab`).addClass('active');
            [attendanceTable, employeesTable, reportTable, payrollTable].forEach(tbl => tbl?.columns.adjust().draw());
            updateCharts();
        });

        // Load Data
        async function loadAttendance() {
            const snap = await db.collection('attendance').orderBy('timestamp','desc').get();
            attendanceData = snap.docs.map(d => ({ id:d.id, ...d.data() }));
            initAttendanceTable(attendanceData); updateEmployeeFilter(); $('#loading-section').hide();
        }
        async function loadEmployees() {
            const snap = await db.collection('employees').orderBy('name').get();
            employeesData = snap.docs.map(d => ({ id:d.id, ...d.data() }));
            initEmployeesTable(employeesData);
        }

        // Tables init
        function initAttendanceTable(data) {
            attendanceTable?.destroy();
            attendanceTable = $('#attendance-table').DataTable({
                data, responsive:true, order:[[1,'desc'] ],
                columns: [
                    { data:'name' },
                    { data:'date', render: d=>formatDateForDisplay(d) },
                    { data:'time' },
                    { data:'type' },
                    { data:'coordinates', render:c=>c?`${c.latitude.toFixed(6)},${c.longitude.toFixed(6)}`:'-' },
                    { data:'workHours', render: h=>h?`${h} ساعة`:'-' }
                ],
                dom:'Bfrtip', buttons:['excel','pdf','print'],
                language:{ url:'//cdn.datatables.net/plug-ins/1.13.3/i18n/ar.json' }
            });
        }
        function initEmployeesTable(data) {
            employeesTable?.destroy();
            employeesTable = $('#employees-table').DataTable({
                data, responsive:true,
                columns:[
                    { data:'name' },
                    { data:null, render: r=>r.phone?`هاتف: ${r.phone}<br/>بريد: ${r.email||'-'}`:'-' },
                    { data:'hireDate', render: d=>formatDateForDisplay(d) },
                    { data:'baseSalary', render:s=>`${s.toLocaleString()} جنيه` },
                    { data:'id', render:id=>`<button class="edit-employee" data-id="${id}"><i class="fas fa-edit"></i></button>
                                                 <button class="delete-employee" data-id="${id}"><i class="fas fa-trash-alt"></i></button>` }
                ],
                dom:'Bfrtip', buttons:['excel','pdf','print'],
                language:{ url:'//cdn.datatables.net/plug-ins/1.13.3/i18n/ar.json' }
            });
        }

        // Employee modal
        $('#add-employee-btn').on('click', ()=>showEmployeeModal());
        $('.close-modal').on('click', ()=>$('#employee-modal').addClass('hidden'));
        function showEmployeeModal(emp={}){
            isEditMode = !!emp.id;
            $('#modal-title').text(isEditMode? 'تعديل الموظف':'إضافة موظف جديد');
            $('#employee-id').val(emp.id||'');
            $('#employee-name-input').val(emp.name||'');
            $('#employee-phone-input').val(emp.phone||'');
            $('#employee-hire-date-input').val(emp.hireDate||'');
            $('#employee-salary-input').val(emp.baseSalary||'');
            $('#employee-modal').removeClass('hidden');
        }
        $('#employee-form').on('submit', async e=>{
            e.preventDefault();
            const id = $('#employee-id').val();
            const data = {
                name: $('#employee-name-input').val(),
                phone: $('#employee-phone-input').val(),
                hireDate: $('#employee-hire-date-input').val(),
                baseSalary: parseFloat($('#employee-salary-input').val()),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try{
                if(id) await db.collection('employees').doc(id).update(data);
                else { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection('employees').add(data);}  
                $('#employee-modal').addClass('hidden'); loadEmployees(); updateEmployeeFilter();
            }catch(err){ alert(err.message);}        });
        $(document).on('click','.edit-employee', e=>{
            const emp = employeesData.find(x=>x.id===e.currentTarget.dataset.id);
            showEmployeeModal(emp);
        });
        $(document).on('click','.delete-employee', async e=>{
            if(confirm('تأكيد الحذف؟')){
                await db.collection('employees').doc(e.currentTarget.dataset.id).delete(); loadEmployees(); updateEmployeeFilter();
            }
        });

        // Filters
        $('#filter-date').on('click',()=> filterAttendance(r=>{
            const from = $('#date-from').val(), to = $('#date-to').val();
            return (!from||r.date>=from)&&(!to||r.date<=to);
        }));
        $('#filter-employee').on('click',()=> filterAttendance(r=>$('#employee-filter').val()?r.name===$('#employee-filter').val():true));
        $('#filter-type').on('click',()=> filterAttendance(r=>$('#type-filter').val()?r.type===$('#type-filter').val():true));
        function filterAttendance(fn){ const filtered=attendanceData.filter(fn); initAttendanceTable(filtered);}        
        function updateEmployeeFilter(){ const sel=$('#employee-filter').empty().append('<option>جميع الموظفين</option>');
            [...new Set(attendanceData.map(r=>r.name))].sort().forEach(name=>sel.append(`<option>${name}</option>`));
        }

        // Charts
        function initCharts(){
            attendanceChart = new Chart($('#attendance-chart'),{type:'bar',data:{labels:[],datasets:[{label:'حضور',data:[]},{label:'غياب',data:[]} ]},options:{responsive:true}});
            hoursChart = new Chart($('#hours-chart'),{type:'pie',data:{labels:[],datasets:[{data:[]} ]},options:{responsive:true}});
        }
        function updateCharts(){ if(!attendanceData.length)return;
            // Monthly attendance
            const months={}, now=new Date(); for(let i=0;i<6;i++){ const d=new Date(now.getFullYear(),now.getMonth()-i,1);
                const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                months[key]={att:0,abs:22,name:d.toLocaleDateString('ar-SA',{month:'long',year:'numeric'})}; }
            attendanceData.filter(r=>r.type==='حضور').forEach(r=>{
                const m=r.date.slice(0,7); if(months[m]){ months[m].att++; months[m].abs--; }
            });
            const keys=Object.keys(months).sort();
            attendanceChart.data.labels=keys.map(k=>months[k].name);
            attendanceChart.data.datasets[0].data=keys.map(k=>months[k].att);
            attendanceChart.data.datasets[1].data=keys.map(k=>months[k].abs);
            attendanceChart.update();
            // Hours
            const hrs={}; attendanceData.forEach(r=>{ if(r.workHours) hrs[r.name]=(hrs[r.name]||0)+r.workHours; });
            const top=Object.entries(hrs).sort((a,b)=>b[1]-a[1]).slice(0,8);
            hoursChart.data.labels=top.map(t=>t[0]); hoursChart.data.datasets[0].data=top.map(t=>t[1]); hoursChart.update();
        }

        // Reports & Payroll
        function getWorkingDays(start,end){ let c=0,d=new Date(start); while(d<=end){ if(d.getDay()!==5 && d.getDay()!==6) c++; d.setDate(d.getDate()+1);} return c; }

        $('#generate-report').on('click',()=>{
            const m=$('#report-month').val(); if(!m)return alert('اختر الشهر');
            const [y,mo]=m.split('-'), start=`${m}-01`, end=`${y}-${mo}-${new Date(y,mo,0).getDate()}`;
            $('#report-title').text(new Date(y,mo-1).toLocaleDateString('ar-SA',{month:'long',year:'numeric'}));
            const period=attendanceData.filter(r=>r.date>=start&&r.date<=end);
            const days=getWorkingDays(new Date(start),new Date(end));
            const report={};
            period.forEach(r=>{ if(!report[r.name]) report[r.name]={name:r.name,attDays:0,late:0,totalH:0};
                if(r.type==='حضور'){ report[r.name].attDays++; if(+r.time.split(':')[0]>=9) report[r.name].late++; }
                report[r.name].totalH+=r.workHours||0;
            });
            const tblData=Object.values(report).map(o=>({
                name:o.name,
                attendanceDays:o.attDays,
                absenceDays:days-o.attDays,
                totalHours:o.totalH.toFixed(2),
                averageHours: o.attDays? (o.totalH/o.attDays).toFixed(2):0,
                lateCount:o.late
            }));
            reportTable?.destroy();
            reportTable=$('#report-table').DataTable({ data:tblData,paging:false,searching:false,info:false,responsive:true,columns:[
                {data:'name'}, {data:'attendanceDays'}, {data:'absenceDays'}, {data:'totalHours',render:d=>d+' ساعة'}, {data:'averageHours',render:d=>d+' ساعة'}, {data:'lateCount'}
            ],language:{url:'//cdn.datatables.net/plug-ins/1.13.3/i18n/ar.json'} });
        });

        $('#calculate-payroll').on('click',()=>{
            const m=$('#payroll-month').val(); if(!m)return alert('اختر الشهر');
            const [y,mo]=m.split('-'), start=`${m}-01`, end=`${y}-${mo}-${new Date(y,mo,0).getDate()}`;
            $('#payroll-title').text(new Date(y,mo-1).toLocaleDateString('ar-SA',{month:'long',year:'numeric'}));
            const period=attendanceData.filter(r=>r.date>=start&&r.date<=end);
            const days=getWorkingDays(new Date(start),new Date(end));
            const payroll=[];
            employeesData.forEach(emp=>{
                const rec=period.filter(r=>r.name===emp.name);
                const attDays=new Set(rec.filter(r=>r.type==='حضور').map(r=>r.date)).size;
                const totalH=rec.reduce((s,r)=>s+(r.workHours||0),0);
                const allowance=attDays/days>=0.95?emp.baseSalary*0.1:0;
                const deduction=(days-attDays)*(emp.baseSalary/days);
                const net=emp.baseSalary+allowance-deduction;
                payroll.push({
                    name:emp.name,
                    baseSalary:emp.baseSalary,
                    workDays:attDays,
                    totalHours:totalH.toFixed(2),
                    allowances:allowance.toFixed(2),
                    deductions:deduction.toFixed(2),
                    netSalary:net.toFixed(2)
                });
            });
            payrollTable?.destroy();
            payrollTable=$('#payroll-table').DataTable({ data:payroll,paging:false,searching:false,info:false,responsive:true,columns:[
                {data:'name'},{data:'baseSalary',render:d=>`${parseFloat(d).toLocaleString()} جنيه`},
                {data:'workDays'},{data:'totalHours',render:d=>d+' ساعة'},{data:'allowances',render:d=>`${parseFloat(d).toLocaleString()} جنيه`},
                {data:'deductions',render:d=>`${parseFloat(d).toLocaleString()} جنيه`},{data:'netSalary',render:d=>`${parseFloat(d).toLocaleString()} جنيه`}
            ],language:{url:'//cdn.datatables.net/plug-ins/1.13.3/i18n/ar.json'} });
        });

        // Initialize
        function initApp(){
            loadAttendance(); loadEmployees(); initCharts();
            const now=new Date(); $('#date-to').val(formatDate(now));
            const lm=new Date(now.setMonth(now.getMonth()-1)); $('#date-from').val(formatDate(lm));
            const cm=formatDate(); $('#report-month,#payroll-month').val(cm.slice(0,7));
        }
    </script>
</body>
</html>
